# 리드레플리카

RDS(Relational Database Service)에서 라이터 인스턴스와 리드 인스턴스를 나누는 이유

## **라이터 인스턴스와 리드 인스턴스 분리 이유**

1. **부하 분산**
    - 데이터베이스 서버에 동시에 많은 요청이 발생할 경우, 단일 서버에 모든 쓰기(Write)와 읽기(Read) 요청이 집중되어 성능 저하나 지연이 발생할 수 있음
    - 라이터 인스턴스를 통해 데이터의 쓰기 작업을 처리하고, 하나 이상의 리드 인스턴스(리드 레플리카)를 통해 읽기 요청을 분산시키면 이러한 문제를 완화가능
2. **성능 최적화**
    - 쓰기 작업은 일반적으로 데이터베이스의 리소스를 많이 사용
    - 리드 인스턴스는 쓰기 작업에서 오는 부하를 받지 않기 때문에, 읽기 작업에 더 효율적으로 자원을 사용할 수 있으며, 이로 인해 전체 시스템의 성능이 향상됨
3. **고가용성과 내구성 향상**
    - 라이터 인스턴스에 문제가 발생했을 때, 리드 인스턴스를 라이터 인스턴스로 승격시켜 서비스의 중단 시간을 최소화할 수 있음, 이는 시스템의 내구성과 고가용성을 보장하는 데 중요한 역할을 함

## **리드 레플리카란?**

- 리드 레플리카는 주 데이터베이스(라이터 인스턴스)의 실시간 복사본
- 모든 쓰기 작업이 주 데이터베이스에서 수행된 후 해당 데이터를 리드 레플리카로 비동기적으로 복제
- 리드 레플리카의 주요 목적은 데이터 읽기 요청을 처리하는 것
    - 이를 통해 주 데이터베이스의 부하를 줄이고, 읽기 작업의 성능을 향상시킬 수 있음

## **리드 레플리카의 주요 특징**

- **스케일 아웃**
    - 시스템의 읽기 처리 능력을 수평적으로 확장할 수 있음
    - 요청이 많은 시간에는 리드 레플리카를 추가하여 처리 능력을 늘릴 수 있음
- **지역적 최적화**
    - 전 세계 다양한 지역에 리드 레플리카를 배치하여 지역적으로 데이터 접근성을 높이고 응답 시간을 줄일 수 있
- **백업 용도**
    - 리드 레플리카를 백업 용도로 사용할 수도 있으며, 데이터 보안성을 높일 수 있음

## **[Django DB Router로 Database Read Replicas 100% 활용기 및 Troubleshooting 경험 공유 - 한종원 - PyCon.KR 2019](https://www.youtube.com/watch?v=eAP8zimx05M)**

## Cloud 인프라 Abstraction Level

- SaaS: Software 통채로 대여
- PaaS: Platform까지 대여
    - AWS RDS
        - 설치, 최적화, 보안, 로깅, 모니터링같은 부분을 다 알아서 해줌
- IaaS: Infarastructure만 대여
    - ec2에 직접 DB 설치해서 환경 구축하는 경우
- On-Premises: Cloud 안 쓰는 경우

### Django DB Router 도입기

v1

- Router db_for_write함수에서는 `default`를, db_for_read 함수에서 `replica`를 쓰도록 함
    - db_for_read에서 replica만 사용하면 라이터 인스턴스를 활용 못함

v2

- random.choice로 라이터, 리드 인스턴스에 50/50 분산처리되도록 수정
    - DB lock을 명시적으로 활용할 때 시점문제가 발생함

v3

- 처리중인 트랜잭션이 존재할 경우 무조건 `default`를 사용하도록 함
    
    ```python
    def db_for_read(model, **hints):
        conn = transaction.get_connection('default')
        if conn.in_atomic_block:
            return 'default'
        databases = ['default', 'replica']
        
        return random.choice(databases)
    ```
    
- 리드 레플리카 추가 시 50/50(25/25)로 나눠지는 문제가 발생함

v4

2018년 11월에 추가된 Custom Endpoint 기능을 쓰면 리드 레플리카 여러개를 하나의 엔드포인트로 묶어서 분산시킬 수 있었음

### Django DB Router로 DB 리드 레플리카 사용 장단점

- 단점
    - 멀티 DB 사용에 대비가 안된 3rd library를 사용 시 문제 발생가능
        - 기본 DB명이 `default`가 아닌 경우 문제가 발생하는 경우도 있음(라이브러리 내에 하드코딩된 경우 존재)
    - lock관련된 의외의 문제가 종종 발생가능
- 장점
    - 더 이상 스케일업이 불필요
        - 스케일업을 위해 DB를 재시작할 필요가 없음 ⇒ 무중단 확장(스케일아웃)이 가능
    - 남는 리드 레플리카의 활용도를 높일 수 있음
